#include "kutil.h"

#include <errno.h>
#include <pthread.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <unistd.h>

static void *handler(void *arg) {
  long fd = *(int *)arg;

  void *src = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE,
                   MAP_PRIVATE | MAP_ANON, -1, 0);
  if (src == MAP_FAILED) {
    ABORT("mmap");
  }

  int count;
  for (count = 0; 1; count++) {
    struct uffd_msg uffd_msg;
    userfaultfd_wait(fd, &uffd_msg);

    switch (count) {
    default: {
    }
    }

    unsigned long dst =
        (unsigned long)uffd_msg.arg.pagefault.address & ~(PAGE_SIZE - 1);
    userfaultfd_copy(fd, (void *)dst, src);
  }
}

int main() {
  void *addr = mmap((void *)0x77770000, 0x1000, PROT_READ | PROT_WRITE,
                    MAP_FIXED | MAP_PRIVATE | MAP_ANON, -1, 0);
  if (addr == MAP_FAILED) {
    ABORT("mmap");
  }

  int fd = userfaultfd();
  userfaultfd_register(fd, addr, PAGE_SIZE);

  pthread_t thread;
  int err = pthread_create(&thread, NULL, handler, (void *)&fd);
  if (err != 0) {
    errno = err;
    ABORT("pthread_create");
  }
}
